<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BreatheAI - Agentic Air Quality</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --glass-bg: rgba(15, 23, 42, 0.6); /* Darker glass for better contrast */
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-primary: #ffffff;
            --text-secondary: #cbd5e1; /* Lighter secondary for better contrast */
            --accent: #38bdf8; /* Sky blue accent */
            --card-radius: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            /* Blue Sky & Clouds Pattern */
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.4) 0%, transparent 20%),
                radial-gradient(circle at 80% 50%, rgba(255, 255, 255, 0.3) 0%, transparent 20%),
                linear-gradient(135deg, #0288d1 0%, #29b6f6 50%, #b3e5fc 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
        }

        .container {
            width: 100%;
            max-width: 1400px; /* Wider container */
            background: rgba(15, 23, 42, 0.4); /* Subtle dark overlay */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 32px;
            border: 1px solid var(--glass-border);
            padding: 2.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            text-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        p.subtitle {
            color: #e0f2fe;
            font-size: 1.2rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        /* Search Controls */
        .location-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            width: 100%;
        }

        .search-container {
            display: flex;
            gap: 0.8rem;
            width: 100%;
            max-width: 700px;
            position: relative;
        }

        select, input {
            padding: 1rem;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            border-color: var(--accent);
        }

        select {
            width: 150px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        input {
            flex-grow: 1;
        }

        .search-results {
            width: 100%;
            max-width: 700px;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            background: rgba(15, 23, 42, 0.95);
            padding: 1rem;
            border-radius: 16px;
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 100;
            border: 1px solid var(--glass-border);
            margin-top: 0.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .result-item {
            padding: 0.8rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .result-item:hover {
            background: var(--accent);
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 1rem;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button.secondary {
            background: transparent;
            border: 1px solid var(--glass-border);
        }

        button.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .loading {
            text-align: center;
            display: none;
            margin: 2rem 0;
            font-size: 1.2rem;
            color: var(--accent);
        }

        /* Bento Grid Dashboard */
        .dashboard {
            display: none;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: auto auto auto; /* Flexible rows */
            gap: 1.5rem;
            width: 100%;
        }

        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 1.5rem;
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
        }

        .card-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .card-sub {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
        }

        /* Specific Card Placements */
        
        /* Pollutant Radar: Top Left, 2x2 */
        .card-radar {
            grid-column: span 2;
            grid-row: span 2;
            min-height: 400px;
        }

        /* AQI Gauge: Top Right, 2x1 */
        .card-aqi {
            grid-column: span 2;
            min-height: 200px;
        }

        /* Metrics Chart: Middle Right, 2x1 */
        .card-metrics {
            grid-column: span 2;
            min-height: 200px;
        }

        /* Small Cards Row: Bottom, 1x1 each */
        .card-small {
            grid-column: span 1;
            min-height: 150px;
            text-align: center;
            justify-content: center;
            align-items: center;
        }

        /* Health Advice: Full Width */
        .card-advice {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        /* Planner Agent Card */
        .card-planner {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .planner-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .planner-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 12px;
        }

        .planner-time {
            font-weight: 700;
            color: #4ade80; /* Green accent */
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .planner-list {
            list-style: none;
            font-size: 1.05rem; /* Increased from 0.9rem */
            color: var(--text-secondary);
        }

        .planner-list li {
            margin-bottom: 0.3rem;
            display: flex;
            align-items: start;
            gap: 0.5rem;
        }

        .planner-list li::before {
            content: "‚Ä¢";
            color: #4ade80;
        }

        .health-content {
            font-size: 1rem;
            line-height: 1.6;
        }
        
        .health-content h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        /* Responsive adjustments */
        .location-sub-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
            justify-content: center;
        }

        .divider {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Responsive adjustments */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .card-radar, .card-aqi, .card-metrics, .card-small, .card-advice, .card-planner {
                grid-column: span 1;
                grid-row: auto;
            }
            .planner-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }
            
            .container {
                padding: 1.5rem;
                border-radius: 24px;
            }

            h1 {
                font-size: 2.5rem;
            }

            .search-container {
                flex-direction: column;
            }

            select, input, button {
                width: 100%;
            }
            
            select {
                background-position: right 1rem center;
            }

            .location-controls {
                gap: 1.5rem;
            }

            .location-sub-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .card-radar {
                min-height: 300px;
            }
        }

        /* AQI Color classes */
        .aqi-good { color: #4ade80; }
        .aqi-moderate { color: #fbbf24; }
        .aqi-unhealthy { color: #fb923c; }
        .aqi-hazardous { color: #ef4444; }

        /* Footer */
        footer {
            margin-top: 3rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            padding-bottom: 1rem;
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>BreatheAI</h1>
            <p class="subtitle">Clarity in every breath.</p>
        </header>

        <div class="location-controls">
            <div class="search-container">
                <select id="country-select">
                    <option value="">Loading...</option>
                </select>
                <input type="text" id="city-input" placeholder="Enter City Name (e.g. London)">
                <button onclick="searchLocation()">üîç Find</button>
                
                <div id="search-results" class="search-results"></div>
            </div>
            
            <div class="location-sub-controls">
                <span class="divider">OR</span>
                <button class="secondary" onclick="getLocation()">üìç Use My Location</button>
            </div>
        </div>

        <div id="loading" class="loading">
            ü§ñ Agents are gathering data and reasoning...
        </div>

        <div id="dashboard" class="dashboard">
            
            <!-- 1. Pollutant Radar (Top Left, 2x2) -->
            <div class="card card-radar">
                <div class="card-label">Pollutant Breakdown</div>
                <div style="flex-grow: 1; position: relative;">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <!-- 2. AQI Gauge (Top Right, 2x1) -->
            <div class="card card-aqi">
                <div class="card-label">Air Quality Index</div>
                <div style="position: relative; height: 100%; display: flex; justify-content: center; align-items: center;">
                    <canvas id="aqiChart"></canvas>
                    <div style="position: absolute; text-align: center; top: 60%;">
                        <div class="card-value" id="aqi-value">--</div>
                        <div class="card-sub" id="aqi-status">--</div>
                    </div>
                </div>
            </div>

            <!-- 3. Metrics Chart (Middle Right, 2x1) -->
            <div class="card card-metrics">
                <div class="card-label">Environment Metrics</div>
                <div style="flex-grow: 1;">
                    <canvas id="metricsChart"></canvas>
                </div>
            </div>

            <!-- 4. Small Cards Row -->
            
            <!-- Weather -->
            <div class="card card-small">
                <div class="card-label">Weather</div>
                <img id="weather-icon" src="" alt="Icon" style="width: 50px; height: 50px; display: none; margin: 0 auto;">
                <div class="card-value" id="temp-value" style="font-size: 1.5rem;">--¬∞C</div>
                <div class="card-sub" id="weather-desc">--</div>
            </div>

            <!-- Humidity -->
            <div class="card card-small">
                <div class="card-label">Humidity</div>
                <div style="font-size: 2rem;">üíß</div>
                <div class="card-value" id="humidity-value" style="font-size: 1.5rem;">--%</div>
                <div class="card-sub">Relative</div>
            </div>

            <!-- Dominant Pollutant -->
            <div class="card card-small">
                <div class="card-label">Main Pollutant</div>
                <div style="font-size: 2rem;">üå´Ô∏è</div>
                <div class="card-value" id="dom-pol-value" style="font-size: 1.5rem;">--</div>
                <div class="card-sub">Highest Conc.</div>
            </div>

            <!-- Risk Level -->
            <div class="card card-small">
                <div class="card-label">Risk Level</div>
                <div id="risk-icon" style="font-size: 2rem;">--</div>
                <div class="card-value" id="risk-value" style="font-size: 1.2rem;">--</div>
                <div class="card-sub">Based on AQI</div>
            </div>

            <!-- 5. Health Advice (Full Width) -->
            <div class="card card-advice">
                <div class="card-label">üß† AI Health Assessment</div>
                <div id="health-content" class="health-content">
                    Waiting for analysis...
                </div>
            </div>

            <!-- 6. Planner Agent (Full Width) -->
            <div class="card card-planner">
                <div class="card-label">üìã Daily Health Plan</div>
                <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                    <div>
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">Mask Recommendation:</span><br>
                        <strong id="mask-rec" style="font-size: 1.1rem;">--</strong>
                    </div>
                    <div>
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">Hydration Goal:</span><br>
                        <strong id="hydration-rec" style="font-size: 1.1rem;">--</strong>
                    </div>
                </div>
                <div class="planner-grid">
                    <div class="planner-item">
                        <div class="planner-time">Morning</div>
                        <ul class="planner-list" id="plan-morning"></ul>
                    </div>
                    <div class="planner-item">
                        <div class="planner-time">Afternoon</div>
                        <ul class="planner-list" id="plan-afternoon"></ul>
                    </div>
                    <div class="planner-item">
                        <div class="planner-time">Evening</div>
                        <ul class="planner-list" id="plan-evening"></ul>
                    </div>
                </div>
            </div>

            </div>
        
        <footer>
            A project by Team Tetrabytes at Mumbai Hacks 2025
        </footer>
    </div>
    </div>

    <script>
        // Load countries on start
        window.onload = async function() {
            try {
                const response = await fetch('https://restcountries.com/v3.1/all?fields=name,cca2');
                const data = await response.json();
                
                const select = document.getElementById('country-select');
                select.innerHTML = '<option value="">Country</option>';
                
                data.sort((a, b) => a.name.common.localeCompare(b.name.common));
                
                data.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.cca2;
                    option.text = country.name.common;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error("Failed to load countries", e);
                document.getElementById('country-select').innerHTML = '<option value="">Error</option>';
            }
        };

        function getLocation() {
            showLoading();
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(fetchData, showError);
            } else {
                alert("Geolocation is not supported by this browser.");
                hideLoading();
            }
        }

        async function searchLocation() {
            const city = document.getElementById('city-input').value;
            const country = document.getElementById('country-select').value;
            const resultsDiv = document.getElementById('search-results');

            if (!city) {
                alert("Please enter a city name");
                return;
            }

            resultsDiv.style.display = 'none';
            showLoading();
            
            try {
                const response = await fetch(`/api/geocode?city=${encodeURIComponent(city)}&country=${country}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server Error ${response.status}: ${errorText.substring(0, 100)}`);
                }

                let data;
                const text = await response.text();
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error(`Invalid JSON response: ${text.substring(0, 100)}...`);
                }

                hideLoading();

                if (data.error) {
                    alert(data.error);
                    return;
                }

                if (data.length === 0) {
                    alert("No locations found.");
                    return;
                }

                if (data.length === 1) {
                    selectLocation(data[0]);
                } else {
                    resultsDiv.innerHTML = '';
                    data.forEach(loc => {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        div.innerText = `${loc.name}, ${loc.state ? loc.state + ', ' : ''}${loc.country}`;
                        div.onclick = () => selectLocation(loc);
                        resultsDiv.appendChild(div);
                    });
                    resultsDiv.style.display = 'flex';
                }

            } catch (e) {
                alert("Search Error: " + e);
                hideLoading();
            }
        }

        function selectLocation(loc) {
            document.getElementById('search-results').style.display = 'none';
            const position = {
                coords: {
                    latitude: loc.lat,
                    longitude: loc.lon
                }
            };
            fetchData(position);
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(error) {
            alert("Error getting location: " + error.message);
            hideLoading();
        }

        async function fetchData(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            showLoading();

            try {
                const response = await fetch(`/api/environment/${lat}/${lon}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server Error ${response.status}: ${errorText.substring(0, 100)}`);
                }

                let data;
                const text = await response.text();
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error(`Invalid JSON response: ${text.substring(0, 100)}...`);
                }

                if (data.error) {
                    alert("API Error: " + data.error);
                    return;
                }

                updateDashboard(data);
            } catch (e) {
                alert("Network Error: " + e);
            } finally {
                hideLoading();
                document.getElementById('dashboard').style.display = 'grid';
            }
        }

        let aqiChartInstance = null;
        let metricsChartInstance = null;
        let radarChartInstance = null;

        function updateCharts(env) {
            // AQI Gauge (Doughnut)
            const ctxAqi = document.getElementById('aqiChart').getContext('2d');
            
            let aqiColor = '#4ade80'; // Good
            if (env.aqi > 50) aqiColor = '#fbbf24'; // Moderate
            if (env.aqi > 100) aqiColor = '#fb923c'; // Unhealthy
            if (env.aqi > 150) aqiColor = '#ef4444'; // Hazardous

            const aqiData = {
                labels: ['AQI', 'Remaining'],
                datasets: [{
                    data: [env.aqi, 500 - env.aqi],
                    backgroundColor: [aqiColor, 'rgba(255, 255, 255, 0.1)'],
                    borderWidth: 0,
                    cutout: '85%',
                    circumference: 180,
                    rotation: 270
                }]
            };

            if (aqiChartInstance) {
                aqiChartInstance.data = aqiData;
                aqiChartInstance.update();
            } else {
                aqiChartInstance = new Chart(ctxAqi, {
                    type: 'doughnut',
                    data: aqiData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    }
                });
            }

            // Metrics Bar Chart
            const ctxMetrics = document.getElementById('metricsChart').getContext('2d');
            const metricsData = {
                labels: ['Temp (¬∞C)', 'Humidity (%)'],
                datasets: [{
                    label: 'Current Conditions',
                    data: [env.temperature, env.humidity],
                    backgroundColor: ['#667eea', '#764ba2'],
                    borderRadius: 8,
                    barThickness: 40
                }]
            };

            if (metricsChartInstance) {
                metricsChartInstance.data = metricsData;
                metricsChartInstance.update();
            } else {
                metricsChartInstance = new Chart(ctxMetrics, {
                    type: 'bar',
                    data: metricsData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                            x: { grid: { display: false }, ticks: { color: '#a0a0a0' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // Radar Chart
            if (env.pollutants) {
                const ctxRadar = document.getElementById('radarChart').getContext('2d');
                const p = env.pollutants;
                const labels = ['PM2.5', 'PM10', 'NO2', 'SO2', 'O3'];
                const data = [
                    p['PM2.5']?.concentration || 0,
                    p['PM10']?.concentration || 0,
                    p['NO2']?.concentration || 0,
                    p['SO2']?.concentration || 0,
                    p['O3']?.concentration || 0
                ];

                const radarData = {
                    labels: labels,
                    datasets: [{
                        label: 'Pollutant Concentration (¬µg/m¬≥)',
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: '#667eea',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#667eea'
                    }]
                };

                if (radarChartInstance) {
                    radarChartInstance.data = radarData;
                    radarChartInstance.update();
                } else {
                    radarChartInstance = new Chart(ctxRadar, {
                        type: 'radar',
                        data: radarData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    pointLabels: { color: '#fff', font: { size: 12 } },
                                    ticks: { display: false, backdropColor: 'transparent' }
                                }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            }
        }

        function updateDashboard(data) {
            const env = data.environment;
            let health = data.health_advice;

            // Update Charts
            updateCharts(env);

            // AQI Text
            const aqiVal = document.getElementById('aqi-value');
            aqiVal.innerText = env.aqi;
            
            // Color logic
            aqiVal.className = 'card-value';
            let riskLevel = "Good";
            let riskIcon = "üòä";
            
            if(env.aqi <= 50) {
                aqiVal.classList.add('aqi-good');
                riskLevel = "Good";
                riskIcon = "üòä";
            } else if(env.aqi <= 100) {
                aqiVal.classList.add('aqi-moderate');
                riskLevel = "Moderate";
                riskIcon = "üòê";
            } else if(env.aqi <= 150) {
                aqiVal.classList.add('aqi-unhealthy');
                riskLevel = "Unhealthy";
                riskIcon = "üò∑";
            } else {
                aqiVal.classList.add('aqi-hazardous');
                riskLevel = "Hazardous";
                riskIcon = "‚ò†Ô∏è";
            }

            document.getElementById('aqi-status').innerText = "Overall AQI";

            // Weather
            document.getElementById('temp-value').innerText = env.temperature + "¬∞C";
            document.getElementById('weather-desc').innerText = env.description;
            document.getElementById('humidity-value').innerText = env.humidity + "%";

            // Weather Icon
            if (env.icon) {
                const iconImg = document.getElementById('weather-icon');
                iconImg.src = `https://openweathermap.org/img/wn/${env.icon}@2x.png`;
                iconImg.style.display = 'block';
            }

            // Dominant Pollutant Logic
            let maxPol = "N/A";
            let maxVal = -1;
            if (env.pollutants) {
                const p = env.pollutants;
                // Check key pollutants
                ['PM2.5', 'PM10', 'NO2', 'SO2', 'O3', 'CO'].forEach(key => {
                    if (p[key] && p[key].concentration > maxVal) {
                        maxVal = p[key].concentration;
                        maxPol = key;
                    }
                });
            }
            document.getElementById('dom-pol-value').innerText = maxPol;

            // Risk Level
            document.getElementById('risk-value').innerText = riskLevel;
            document.getElementById('risk-icon').innerText = riskIcon;

            // Health Advice
            const healthDiv = document.getElementById('health-content');
            if (health.includes("Health advice unavailable")) {
                let errorDetail = "The AI health reasoning agent could not connect.";
                const match = health.match(/\(Error: (.*?)\)/);
                if (match && match[1]) errorDetail = match[1];

                healthDiv.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); padding: 1rem; border-radius: 8px; color: #fca5a5;">
                        <strong>‚ö†Ô∏è AI Advice Unavailable</strong><br>
                        <span style="font-size: 0.9rem; opacity: 0.9;">${errorDetail}</span>
                    </div>
                `;
            } else {
                // Render Markdown-ish
                // 1. Headers
                let html = health.replace(/### (.*?)\n/g, '<h3>$1</h3>');
                // 2. Bold
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // 3. Newlines
                html = html.replace(/\n/g, '<br>');
                
                healthDiv.innerHTML = html;
            }

            // Planner Agent
            if (data.daily_plan) {
                const plan = data.daily_plan;
                document.getElementById('mask-rec').innerText = plan.mask_level;
                document.getElementById('hydration-rec').innerText = plan.hydration_ml + " ml";

                const renderList = (id, items) => {
                    const ul = document.getElementById(id);
                    ul.innerHTML = items.map(item => {
                        // Parse Markdown Bold
                        const formattedItem = item.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        return `<li>${formattedItem}</li>`;
                    }).join('');
                };

                renderList('plan-morning', plan.morning_plan);
                renderList('plan-afternoon', plan.afternoon_plan);
                renderList('plan-evening', plan.evening_plan);
            }
        }
    </script>
</body>
</html>
