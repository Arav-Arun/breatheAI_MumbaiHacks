<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pollution News - BreatheAI</title>
    <link
      rel="icon"
      href="{{ url_for('serve_assets', filename='favicon.jpg') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}?v=6"
    />
    <script defer src="/_vercel/insights/script.js"></script>
  </head>
  <body class="news-page">
    <div class="container">
      <header class="news-header">
        <a href="/" class="back-button">← Back to Dashboard</a>
        <h1>Local Pollution News</h1>
        <p id="news-subtitle">Latest updates for your location</p>

        <div class="filter-controls">
          <input
            type="text"
            id="search-input"
            placeholder="Search news..."
            class="filter-input"
          />
          <select id="source-filter" class="filter-select">
            <option value="all">All Sources</option>
          </select>
        </div>
      </header>

      <div id="loading" class="loading-spinner"></div>
      <div id="news-grid" class="news-grid"></div>
    </div>

    <script>
      let allNews = [];
      let displayedCount = 0;
      const BATCH_SIZE = 10;
      let isLoadingMore = false;

      document.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const city = urlParams.get("city") || "India";

        // Fix Back Button
        document.querySelector(
          ".back-button"
        ).href = `/?city=${encodeURIComponent(city)}`;

        document.getElementById(
          "news-subtitle"
        ).innerText = `Latest updates for ${city}`;

        try {
          // Fetch large batch for infinite scroll simulation
          const response = await fetch(
            `/api/news/${encodeURIComponent(city)}?limit=50`
          );
          allNews = await response.json();

          populateSourceFilter(allNews);

          // Initial Render
          renderNextBatch();

          document.getElementById("loading").style.display = "none";

          // Event Listeners
          document
            .getElementById("search-input")
            .addEventListener("input", () => {
              displayedCount = 0;
              document.getElementById("news-grid").innerHTML = "";
              filterNews();
            });
          document
            .getElementById("source-filter")
            .addEventListener("change", () => {
              displayedCount = 0;
              document.getElementById("news-grid").innerHTML = "";
              filterNews();
            });

          // Infinite Scroll Listener
          window.addEventListener("scroll", handleScroll);
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("loading").innerHTML = "Failed to load news.";
        }
      });

      function handleScroll() {
        if (isLoadingMore) return;

        const { scrollTop, scrollHeight, clientHeight } =
          document.documentElement;

        if (scrollTop + clientHeight >= scrollHeight - 50) {
          // User is near bottom
          renderNextBatch();
        }
      }

      function populateSourceFilter(news) {
        const sources = new Set(news.map((item) => item.source));
        const select = document.getElementById("source-filter");
        sources.forEach((source) => {
          const option = document.createElement("option");
          option.value = source;
          option.textContent = source;
          select.appendChild(option);
        });
      }

      function filterNews() {
        const searchTerm = document
          .getElementById("search-input")
          .value.toLowerCase();
        const sourceFilter = document.getElementById("source-filter").value;

        const filtered = allNews.filter((item) => {
          const matchesSearch = item.title.toLowerCase().includes(searchTerm);
          const matchesSource =
            sourceFilter === "all" || item.source === sourceFilter;
          return matchesSearch && matchesSource;
        });

        // Reset grid and render filtered results (no pagination for simplicity on filter)
        // Or re-implement pagination for filtered list if needed.
        // For now, render all filtered to avoid complex state
        renderNewsGrid(filtered);
      }

      function renderNextBatch() {
        if (displayedCount >= allNews.length) return;

        isLoadingMore = true;
        const end = Math.min(displayedCount + BATCH_SIZE, allNews.length);
        const batch = allNews.slice(displayedCount, end);

        appendNewsItems(batch);
        displayedCount = end;
        isLoadingMore = false;
      }

      function renderNewsGrid(news) {
        const grid = document.getElementById("news-grid");
        grid.innerHTML = "";
        if (news.length === 0) {
          grid.innerHTML =
            '<p class="no-news">No news found matching your filters.</p>';
          return;
        }
        appendNewsItems(news);
      }

      function appendNewsItems(news) {
        const grid = document.getElementById("news-grid");

        news.forEach((item) => {
          const card = document.createElement("div");
          card.className = "news-card-bento"; // Removed "featured" logic for simple infinite scroll

          // Format date
          const date = new Date(item.date).toLocaleDateString(undefined, {
            month: "short",
            day: "numeric",
            year: "numeric",
          });

          card.innerHTML = `
                      <div class="news-content">
                          <span class="news-source">${item.source} • ${date}</span>
                          <h3><a href="${item.link}" target="_self">${item.title}</a></h3>
                          <a href="${item.link}" target="_self" class="read-more">Read Article ↗</a>
                      </div>
                  `;
          grid.appendChild(card);
        });
      }
    </script>
  </body>
</html>
